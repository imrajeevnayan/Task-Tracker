<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #e0e7ff, #c7d2fe);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #editModal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-10px);
        }
        #editModal:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }
        #editModal.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }
        .task-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans text-gray-900">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-indigo-600 tracking-tight">Task Tracker</h1>
            <p class="mt-2 text-lg text-gray-500" id="taskCount">Total Tasks: 0</p>
        </header>

        <!-- Task Form -->
        <section class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Create New Task</h2>
            <div class="space-y-5">
                <input id="title" type="text" placeholder="Task Title (max 100 characters)" required
                       maxlength="100" aria-label="Task Title"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                <textarea id="description" placeholder="Task Description (max 500 characters)" maxlength="500"
                          aria-label="Task Description"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition resize-none h-32"></textarea>
                <div class="flex items-center">
                    <input id="completed" type="checkbox" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 rounded"
                           aria-label="Mark task as completed">
                    <label for="completed" class="ml-3 text-gray-700 font-medium">Completed</label>
                </div>
                <button onclick="addTask()"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center font-medium"
                        aria-label="Add new task">
                    <span id="addButtonText">Add Task</span>
                    <span id="addSpinner" class="spinner hidden ml-3"></span>
                </button>
            </div>
            <p id="message" class="mt-4 text-sm text-center font-medium" aria-live="polite"></p>
        </section>

        <!-- Task List -->
        <section id="tasks" class="space-y-4">
            <p id="loadingMessage" class="text-center text-gray-500 font-medium">Loading tasks...</p>
        </section>

        <!-- Edit Task Modal -->
        <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 sm:p-8 w-full max-w-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Edit Task</h2>
                <input id="editTitle" type="text" placeholder="Task Title (max 100 characters)" required
                       maxlength="100" aria-label="Edit Task Title"
                       class="w-full p-3 border border-gray-300 rounded-lg mb-5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                <textarea id="editDescription" placeholder="Task Description (max 500 characters)" maxlength="500"
                          aria-label="Edit Task Description"
                          class="w-full p-3 border border-gray-300 rounded-lg mb-5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition resize-none h-32"></textarea>
                <div class="flex items-center mb-5">
                    <input id="editCompleted" type="checkbox" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 rounded"
                           aria-label="Mark task as completed">
                    <label for="editCompleted" class="ml-3 text-gray-700 font-medium">Completed</label>
                </div>
                <div class="flex space-x-4">
                    <button onclick="saveTask()"
                            class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center font-medium"
                            aria-label="Save task changes">
                        <span id="saveButtonText">Save</span>
                        <span id="saveSpinner" class="spinner hidden ml-3"></span>
                    </button>
                    <button onclick="closeModal()"
                            class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300 transition duration-300 font-medium"
                            aria-label="Cancel editing">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;

        // Load tasks on page load
        loadTasks();

        function loadTasks() {
            showLoading(true, 'tasks');
            fetch('/api/tasks')
                .then(response => response.json())
                .then(tasks => {
                    const taskList = document.getElementById('tasks');
                    taskList.innerHTML = '';
                    tasks.forEach((task, index) => {
                        const taskCard = document.createElement('div');
                        taskCard.className = 'task-card bg-white rounded-xl shadow-md p-6 flex justify-between items-center fade-in';
                        taskCard.style.animationDelay = `${index * 0.1}s`;
                        taskCard.innerHTML = `
                            <div>
                                <h3 class="text-xl font-semibold ${task.completed ? 'line-through text-gray-400' : 'text-gray-800'}">
                                    ${task.title}
                                </h3>
                                <p class="text-gray-600 mt-1">${task.description || 'No description'}</p>
                                <p class="text-sm text-gray-500 mt-2">Created: ${new Date(task.createdAt).toLocaleString()}</p>
                                <p class="text-sm text-gray-500">Updated: ${new Date(task.updatedAt).toLocaleString()}</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="openEditModal(${task.id}, '${task.title.replace(/'/g, "\\'")}', '${task.description ? task.description.replace(/'/g, "\\'") : ''}', ${task.completed})"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 font-medium"
                                        aria-label="Edit task: ${task.title}">
                                    Edit
                                </button>
                                <button onclick="toggleTask(${task.id}, ${!task.completed})"
                                        class="px-4 py-2 bg-${task.completed ? 'green' : 'yellow'}-500 text-white rounded-lg hover:bg-${task.completed ? 'green' : 'yellow'}-600 transition duration-200 font-medium"
                                        aria-label="${task.completed ? 'Mark task incomplete' : 'Mark task complete'}">
                                    Toggle
                                </button>
                                <button onclick="deleteTask(${task.id})"
                                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 font-medium"
                                        aria-label="Delete task: ${task.title}">
                                    Delete
                                </button>
                            </div>
                        `;
                        taskList.appendChild(taskCard);
                    });
                    document.getElementById('taskCount').textContent = `Total Tasks: ${tasks.length}`;
                    showLoading(false, 'tasks');
                })
                .catch(error => {
                    showLoading(false, 'tasks');
                    showMessage('Error loading tasks ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                });
        }

        function addTask() {
            const task = {
                title: document.getElementById('title').value.trim(),
                description: document.getElementById('description').value.trim(),
                completed: document.getElementById('completed').checked
            };
            if (!task.title) {
                showMessage('Title is required ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                return;
            }
            if (task.title.length > 100) {
                showMessage('Title must be 100 characters or less ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                return;
            }
            if (task.description.length > 500) {
                showMessage('Description must be 500 characters or less ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                return;
            }
            showLoading(true, 'add');
            fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return response.json().then(err => { throw err; });
                })
                .then(data => {
                    loadTasks();
                    document.getElementById('title').value = '';
                    document.getElementById('description').value = '';
                    document.getElementById('completed').checked = false;
                    showLoading(false, 'add');
                    showMessage('Task added successfully ✅', 'text-green-600 bg-green-100 p-3 rounded-lg');
                })
                .catch(error => {
                    showLoading(false, 'add');
                    const message = error.title || error.description || error.error || 'Error adding task ❌';
                    showMessage(message, 'text-red-600 bg-red-100 p-3 rounded-lg');
                });
        }

        function toggleTask(id, completed) {
            const task = { completed };
            showLoading(true, 'tasks');
            fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            })
                .then(response => {
                    if (response.ok) {
                        loadTasks();
                        showMessage('Task completion updated successfully ✅', 'text-green-600 bg-green-100 p-3 rounded-lg');
                    } else {
                        throw new Error('Failed to update task');
                    }
                })
                .catch(error => {
                    showLoading(false, 'tasks');
                    showMessage('Error updating task completion ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                });
        }

        function deleteTask(id) {
            showLoading(true, 'tasks');
            fetch(`/api/tasks/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        loadTasks();
                        showMessage('Task deleted successfully ✅', 'text-green-600 bg-green-100 p-3 rounded-lg');
                    } else {
                        throw new Error('Failed to delete task');
                    }
                })
                .catch(error => {
                    showLoading(false, 'tasks');
                    showMessage('Error deleting task ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                });
        }

        function openEditModal(id, title, description, completed) {
            currentEditId = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editDescription').value = description;
            document.getElementById('editCompleted').checked = completed;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function saveTask() {
            const task = {
                title: document.getElementById('editTitle').value.trim(),
                description: document.getElementById('editDescription').value.trim(),
                completed: document.getElementById('editCompleted').checked
            };
            if (!task.title) {
                showMessage('Title is required ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                return;
            }
            if (task.title.length > 100) {
                showMessage('Title must be 100 characters or less ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                return;
            }
            if (task.description.length > 500) {
                showMessage('Description must be 500 characters or less ❌', 'text-red-600 bg-red-100 p-3 rounded-lg');
                return;
            }
            showLoading(true, 'save');
            fetch(`/api/tasks/${currentEditId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return response.json().then(err => { throw err; });
                })
                .then(data => {
                    loadTasks();
                    closeModal();
                    showMessage('Task updated successfully ✅', 'text-green-600 bg-green-100 p-3 rounded-lg');
                })
                .catch(error => {
                    showLoading(false, 'save');
                    const message = error.title || error.description || error.error || 'Error updating task ❌';
                    showMessage(message, 'text-red-600 bg-red-100 p-3 rounded-lg');
                });
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }

        function showMessage(message, className) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `mt-4 text-sm text-center font-medium ${className} transition-opacity duration-300`;
            setTimeout(() => messageEl.textContent = '', 4000);
        }

        function showLoading(show, context) {
            if (context === 'add') {
                document.getElementById('addButtonText').classList.toggle('hidden', show);
                document.getElementById('addSpinner').classList.toggle('hidden', !show);
            } else if (context === 'save') {
                document.getElementById('saveButtonText').classList.toggle('hidden', show);
                document.getElementById('saveSpinner').classList.toggle('hidden', !show);
            } else if (context === 'tasks') {
                document.getElementById('tasks').classList.toggle('opacity-50', show);
                document.getElementById('loadingMessage').classList.toggle('hidden', !show);
            }
        }
    </script>
</body>
</html>